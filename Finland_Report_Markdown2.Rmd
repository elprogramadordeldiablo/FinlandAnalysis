---
title: "Arthropod Article Report"
author: "Rui Carvalho"
output:
  html_document:
    theme: united
    highlight: tango
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: no
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
options(knitr.table.format = "html")

```

# Introduction

Oceanic islands are home to a large numbers of endemic species, which together with other native species, create unique communities (Whittaker et al, 2007). These communities are often more sensitive to the introduction of exotic and potential invasive species (Jager, 2007).  Biological invasions are a major driver of biodiversity loss (Vitousek et al, 1996; Butchart et al 2010), with ecological and economic implications (Lockwood et al, 2007) and oceanic islands are especially sensitive to this process, and is where the most extinctions took place so far (Whittaker & Fern√°ndez-Palacios, 2007. Additionally, being isolated, many populations are unable to recover from past disturbance events, mainly driven by habitat loss and species introductions (Whittaker & Fern√°ndez-Palacios, 2007).
Habitat loss is a complex processes with many variables to consider: isolation, matrix quality, patch area, shape complexity and edge effects (Didham, 2012). Edge effect defines as the exposure of a given fragmented community to the influence of the surrounding matrix (Cook et al, 2002). Many species avoid edges, and a high proportion edge area in a small habitat can devalue its conservation significance. Edges can change the capacity of fixation of a species, due to changes microclimate  such as temperature, humidity, wind speed, etc (Tscharntke et al, 2002). The disruption of native ecosystems by landscape alterations is often a source of immigrant species and complex source-sink dynamics creating opportunities to higher turnover in non-native species (Matthews et al. 2019 ) . This process can alter the established biotic interactions, eventually providing new ecological opportunities for invaders (Didham, 2007).
Native forest fragments in the Azores are characterized by hard edges, with abrupt changes from native habitats to anthropogenic habitats (Borges et al, 2006, 2008; Matthews et al. 2019). As  such,  it is  likely  to  expect a constant  arrival  of  non-native  species  into  the  native forest, via a source-sink effect (Matthews et al., 2019). However, the establishment of an exotic species implies overcoming several barriers: first, the successful arrival to the new territory (Diez et al, 2012) and then being able to reproduce and to disperse from that point. Invasion is considered successful when a species establishes a self-sustaining population, who can expand to new areas (Blackburn et al, 2011).
Regarding Arthropod dispersal movements between native forest patches and the surrounding habitats in the Azores, two main types of arthropod dispersal trends were described: i) endemic and native species are dispersing from native habitats to human-altered habitats; and ii) many exotic species are dispersing to the native forest (Borges et al., 2008). In our study, we aim to understand and quantify the entry of exotic species into the Azorean native forest. The study of beta-diversity patterns, interpreted as the extent of change in a community composition (Whittaker, 1960), is a crucial tool for such task, since it aims to understand the processes that originate community variation (Carvalho et al., 2013). This variation can be originated in species composition (species being replaced by others), species richness (one community has more species than the other), or both. A considerable number of approaches have been proposed to study beta-diversity patterns, and recently it was proposed to partition the components that originate from underlying processes (Baselga, 2010, Carvalho et al., 2012). Carvalho and colleagues defended that beta values should be disentangled into algebraically comparable fractions, reflecting the replacement and richness-difference components in an ecologically meaningful way, which was also supported by Legende (2015). (
Initially, the analysis of such processes were mostly based on the number of taxa and distribution of abundances ‚Äì Taxonomic Diversity (TD). However, this measure ignores the ecological functions provided by each species in an ecosystem and consequently the role of Functional Diversity (FD). For example, several species in an ecosystem can exhibit a small variation of traits, while few species may perform a large variation of those (Vill√©ger et al., 2012, 2013). Functional diversity (FD) quantifies the components of biodiversity that influence how an ecosystem operates or functions (Tilman et al., 2001).   (Desenvolver mais este tema)Both TD and FD, together with Philogenetic Diversity (PD), have been unified under a methodological and statistical framework for the study of spatial and temporal heterogeneity including its phylogenetic and functional components (Cardoso et al., 2014) along with a statistical package incorporating these innovations (Cardoso et al., 2015).
Adding to the relatively well-documented ecological disturbance processes above described, the increasing rate of visitation of protected areas raises concerns as to whether recreation and tourism activities in protected areas can be sustainably managed (Monz et al., 2009). Several studies even suggest that perceived impacts by users can degrade the quality of visitor‚Äôs experience (Leung et al., 2013). In response to these concerns, a specialized field of study ‚Äì recreation ecology ‚Äì has emerged. Recreation ecology began in the early 1960s (Leung et al., 2013) and is commonly defined as the study of the impacts of outdoor recreation and nature-based tourism activities in natural or semi-natural environments. Modelling the relationship between use and ecological change stood as one of the most sought generalizations in this field. It is often generalized as a curvilinear, asymptotic relationship (Hammitt et al., 1987), largely due to research that focused on easily observable ecological responses and a limited set of variables, such as changes in vegetation cover (Queiroz et al, 2014(1)(2)). Despite recognition that species‚Äô responses to perturbations are not random and that different species may be more or less sensitive to particular disturbance depending on their life-history traits. It is increasingly recognized that functional traits (i.e. components of an organism‚Äôs phenotype that influence ecosystem level processes) better predict the effects of human-disturbance ecosystem functioning than taxonomic species identity alone (Swenson, 2011). 

Intensity of use is the variable most commonly studied in the past for obvious reasons, as it should be both directly related with impact and easily measurable. Yet, other variables of interest should be quantified for better-informed decisions. Recent proposals for modelling the relationship between use and impacts (Monz et al., 2009) are based on long-term studies and suggest that ecological change may be more dynamic and spatially diffuse than these generalizations imply (Kim, 2012). Consequently, future research could more directly model the use‚Äìresponse relationship through more sensitive methods of measurement and improved experimental designs focused on long term monitoring. 
Studies focusing on measurement of dispersal on seeds directly by humans demonstrated that they differ from wind dispersion, confirming that human-associated dispersal allows for seeds to spread to longer distances than the wind. The pattern of propagation is logarithmic, largely decreasing the amount of seeds as distance from the beginning of the trail increases (Whichmann et al., 2009). In the Azores, habitat and plant variables have a significant effect in the richness of arthropod endemic species (Florencio et al, 2016), which in turn are a surrogate group for the arthropod community in these forests (Procurar refer√™ncia ‚Äì j√° li isto). The source-sink process also explains the presence of non-indigenous species, by means of proximity of a certain point of the forest to its edge (Mathews et al., 2019). 

Our hypothesis are: (1) human recreational activities affect the vegetation composition and structure, which in turn affect the spider community. Since this effect is expected to be amplified in the beginning of the trail, pairwise spatial beta taxonomic (TD) and functional (FD) diversity will decrease as the sampling sites go further into the trail; (2) The distance to the edge is a measure of scale for the source-sink effect, and therefore the closest the trail is to the edge, the more likely it is that pairwise spatial beta TD and FD variation is explained by non-human related factors. (3) Both distance to the beginning of the trail and edge distance explain the variation observed in pairwise spatial beta TD and FD values.
Confirming or invalidating these relations will allow us to understand the current relevance of recreational activities on arthropod community dynamics (using spiders as indicators), aiding relevant information to where to prioritize efforts in management of the touristic pressure in the Azorean and Macaronesian native forests.

# Materials and Methods

## Study area

The Azorean archipelago is located in the North Atlantic Ocean, roughly between the coordinates 37¬∫-40¬∫N and 25-31¬∫W longitude. It consists of nine volcanic islands separated into three groups: the western group (Flores and Corvo), the central group (Fail, Pico, S. Jorge, Graciosa and Terceira) and the eastern group (S. Miguel and S. Maria), in addition to small islets. The climate is temperate oceanic, strongly influenced by the surrounding ocean and the topography of the island, which together produce high levels of relative atmospheric humidity and low temperature variation throughout the year. The study was made in the evergreen laurel forest (Laurisilva). Its original area in the archipelago has been drastically reduced since human settlement, and nowadays covers about 5% of the archipelago, in the most unaccessible and mountainous regions. 
For the current investigation was done in pedestrian trails in Terceira and S. Miguel that passed through a patch of native forest.  The forest from both islands does not present structural differences, both being characterized by reduced tree structure (up to 5m, rarely going to 10), shallow soil and roughed terrain. The degree of conservation is, however, much worse at S. Miguel, presenting a dominance by Clethra arborea, while in terceira the forest structure is much closer to a pristine state. From each trail, only the segments that were in native forest were included, excluding other habitats from the study. Once the vegetation structure represented the forest, that as considered the beginning of the study area. Distance within this segment is counted using the most common direction of traffic by tourists. 

## Site Selection

Since in propagation in space from a point, the area increases logarithmically, we have used this scale to select the sites. The trail segment was identified in satellite photography, and then fine tuned in the field. From there, three sites were selected upon a logarithmic gradient of distance by the beginning of the trail, at 0m, 50m and 250m. Another site was added in the section of the trail with the most pristine surrounding forest (Max), and two controls were placed inside the forest, at 50m and 250m from the nearest trail point. Two sites sampled in 2013, with the same methodology, were at about 250m from trails from this study, and such data was used for this study. 

##Sampling procedures

Spiders were sampled using plots of 50x50m. Sampling followed the COBRA Monitoring protocol presented in Borges et al (2018). For each forest fragment, and in order to obtain confidence about the representativity of the sampling , one COBRA Inventory protocol is necessary. The latter comprises four hours of aerial search (AAS), four hours of tree beating (BEAT), four vegetation Sweeping (SEW) and 48 pitfall traps, posteriorly arranged in groups of 4 to make a sample unit. For consistency, the Inventory protocol was always done in the most pristine area known in the fragment. The remaining sites were sampled with the COBRA Monitoring protocol (4 hours AAS and 2 Hours BEAT)
Sorting was made between December 2017 and October 2018 with the aid of an expert taxonomist. The resulting database was then completed with the functional data known to each spider species in the Azores.

## Data Analyses
We analysed the data in three subsets: all species, Indigenous and Non-Indigenous. All analyses were repeated for each subset.
We considered the distance from each sampling point to the trail as a factor, since we expect that the controls will have less non-indigenous species, for not having the edge effects caused by trail infrastructure and the impacts from human use. Distance to edge was elected as a covariate, since the source-sink effect magnitude is dependant on the souce distance. The distance to the beginning of the trail was selected to represent the treatments, since it converts them to a continuous variable and defines precisely the distance of the ‚ÄúMax‚Äù sampling area. 
We considered as dependent variables the three components of beta-diversity ‚Äì Total, Richness and Relapcement, for taxonomic and functional traits separately.
These variables were regressed against the three considered variables in a GLMM, including trail identitiy as a random factor, in order to exclude the location effect from the treatments. The GLMM were implemented in R using Lm4 package. We checked for outliers and correlations between the covariates. 

# Results

## Setting up the file

```{r}
library(BAT)
library(readr)
library(FD) 
library(alphahull)
library(hypervolume)
library(car)
library(MASS)
library(lme4)
library(vegan)
#source(file = "HighstatLibV10.R") #cool tools to support
#library(factoextra) # Useful for PCA analysis
library(here)

```

# DAta used in the file 

#   1.  GLMM_Variables.csv       - data.variables
#   2.  Control250_Fin.csv       - data.alpha.controls
#   3.  Traits_All_Fin.csv       - data.traits.all
#   4.  Traits_Nat_Fin.csv       - data.traits.nat
#   5.  Traits_NInd_Fin.csv      - data.traits.nind
#   6.  All_Fin.csv              - data.all.fin
#   7.  Nat_Fin.csv              - data.nat.fin
#   8.  NInd_Fin.csv             - data.nind.fin
#   9.  MDS_vectors.csv          - data.mds
#   10. Weight_Ratios_Traits.csv - data.wr

## Spider abundance data
Three Site/Species matrixes with species abundance were created, for All species, Native Species and Non-Indigenous species

```{r}
# Ficheiro com as abund‚ncias por ¡rea de amostragem, para todas as amostras
SAAll <- fread(here("data", "All_Fin.csv"), header = T) %>% 
  setnames(old="Trail_Sampling Area", new="TSA")
sites <- as.vector(SAAll$TSA)
# SAAll <- SAAll[,-1]
# rownames(SAAll) <- sites
# colnames(SAAll) <- species
# HEllinger transformation
SAAll.standard <- decostand(SAAll[,-1], "hellinger")
SAAll.standard

# Ficheiro com as abund‚ncias por ·rea de amostragem, para as espÈcies indÌgenas
SANat <- fread(here("data", "Nat_Fin.csv"), header = T) %>% 
  setnames(old="Trail_Sampling Area", new="TSA")
# sites are the same as the previous object
# SANat <- SANat[,-1] 
# rownames(SANat) <- sites
# colnames(SANat) <- species_nat
# HEllinger transformation
SANat.standard <- decostand(SANat[,-1], "hellinger") 
SANat.standard

# 8. data.nind.fin -----------------------
# Ficheiro com as abund‚ncias por ·rea de amostragem, para as espÈcies n„o-indÌgenas
SANInd <- fread(here("data", "NInd_Fin.csv"), header = T) %>% 
  setnames(old="Trail_Sampling Area", new="TSA")
# SANInd <- SANInd[,-1] 
# rownames(SANInd) <- sites
# colnames(SANInd) <- species_nind
# HEllinger transformation
SANInd.standard <- decostand(SANInd[,-1], "hellinger") 
SANInd.standard

```

## Traits data upload

Species_X_ Matrixes adjusted to All species, Native Species and Non-Indigenous species

```{r}
# Matrix with species (rows)x traits (cols) for all species in all plots
data.traits.all  <- read.csv2(here("data", "Traits_All_Fin.csv"), header=TRUE, dec=".")
setDT(data.traits.all)
# edit data.traits.all colnames
setnames(data.traits.all,
         old = c("MF","SPECIES","FAMILY","FAMILY.1","N.E.I","IND.NONNAIND","HABITATNALeaves..branches..flowers..seeds..fruits..surface.","HABITATNAinside.stems..roots..fruits..pods..fungi","HABITATNAGround","HABITATNAUnder.stones..bark..twigs","HABITATNADecaying.matter","HABITATNASubterranean","Stenophagous...Not.Euryphagous"),
         new = c("Mf","Sp","Family.name","Family","Nei","Ind.nonind","Hab.leaves","Hab.inside","Hab.ground","Hab.under","Hab.matter","Hab.sub","Stenophagous"))
data.traits.all
# data.traits.all <- data.traits.all[,c(1:3)]
str(data.traits.all) # as colunas Hab. poderao ser factores 0/1
pairs(data.traits.all[,c(13:18)]) # all same data, might justify the positive pattern
pairs(data.traits.all[,c(19:21)], pch=16)


# 4. data.traits.nat -----------------
# Matrix with species (rows)x traits (cols) for all natives species in all plots
data.traits.nat <- read.csv2(here("data", "Traits_Nat_Fin.csv"), header=TRUE, dec=".")
setDT(data.traits.nat)
colnames(data.traits.nat)
setnames(data.traits.nat,
         old = c("MF","SPECIES","FAMILY","FAMILY.1","N.E.I","IND.NONNAIND","HABITATNALeaves..branches..flowers..seeds..fruits..surface.","HABITATNAinside.stems..roots..fruits..pods..fungi","HABITATNAGround","HABITATNAUnder.stones..bark..twigs","HABITATNADecaying.matter","HABITATNASubterranean","Stenophagous...Not.Euryphagous"),
         new = c("Mf","Sp","Family.name","Family","Nei","Ind.nonind","Hab.leaves","Hab.inside","Hab.ground","Hab.under","Hab.matter","Hab.sub","Stenophagous"))
# mudar os valores de "E " para "E" (sem espaco)
levels(data.traits.nat$Nei) <- c("E", "N")
# ver a estrutura da coluna
as.character(data.traits.nat$Nei)
# estrutura dos dados
str(data.traits.nat)


# 5. data.traits.nind ----------------
# Matrix with species (rows)x traits (cols) for all Non-Indigenous species in all plots
data.traits.nind  <- read.csv2(here("data", "Traits_NInd_Fin.csv"), header=TRUE, dec = ".")
setDT(data.traits.nind)
colnames(data.traits.nind)
setnames(data.traits.nind,
         old = c("MF","SPECIES","FAMILY","FAMILY.1","N.E.I","IND.NONNAIND","HABITATNALeaves..branches..flowers..seeds..fruits..surface.","HABITATNAinside.stems..roots..fruits..pods..fungi","HABITATNAGround","HABITATNAUnder.stones..bark..twigs","HABITATNADecaying.matter","HABITATNASubterranean","Stenophagous...Not.Euryphagous"),
         new = c("Mf","Sp","Family.name","Family","Nei","Ind.nonind","Hab.leaves","Hab.inside","Hab.ground","Hab.under","Hab.matter","Hab.sub","Stenophagous"))
str(data.traits.nind)
summary(data.traits.nind) # h· duas linhas NA
```

## Independent Variables upload

```{r}
data.variables <- fread(here("data", "GLMM_Variables.csv"), stringsAsFactors = T)
colnames(data.variables)
str(data.variables)
summary(data.variables)
# first look at the data.variables dataset
barplot(table(data.variables$ForestID), las=2, main="Forest ID", ylab="Frequency")
barplot(table(data.variables$Treatment), las=2, main="Treatment", ylab="Frequency")
```

## Inventory protocol complete abundances

```{r}
# Ficheiro com as abund‚ncias por amostra para os controlos 250/Max
data.alpha.controls <- fread(here("data", "Control250_Fin.csv"), header = T)
# change column name and transform in in a factor
setnames(data.alpha.controls, old="Trail_Sampling Area", new="TSA")
data.alpha.controls[, TSA:=factor(TSA)]
summary(data.alpha.controls)
```
```{r}
# Vector with weight trail and treatment names for MDS
data.mds <- fread(here("data", "MDS_vectors.csv"))
trail <- unique(as.vector(data.mds$Trail_name))
str(data.mds)
```

## Vector with weight trail and treatment names for MDS
```{r}
data.mds <- fread(here("data", "MDS_vectors.csv"))
trail <- unique(as.vector(data.mds$Trail_name))
str(data.mds)
```

## Loading weight ratios
```{r}
# Vector with weight ratios for trails - used in cluster::daisy to compensate decomposition of one variable by
# multiple columns
data.wr <- read.csv2(here("data", "Weight_Ratios_Traits.csv"), header = TRUE, dec = ".")
setDT(data.wr)
colnames(data.wr)
setnames(data.wr,
         old=c("MF","SPECIES","FAMILY","FAMILY.1","N.E.I","IND.NON.IND","HABITAT.Leaves..branches..flowers..seeds..fruits..surface.","HABITAT.inside.stems..roots..fruits..pods..fungi","HABITAT.Ground","HABITAT.Under.stones..bark..twigs","HABITAT.Decaying.matter","HABITAT.Subterranean","Stenophagous...Not.Euryphagous"),
         new=c("Mf","Sp","Family.name","Family","Nei","Ind.nonind","Hab.leaves","Hab.inside","Hab.ground","Hab.under","Hab.matter","Hab.sub","Stenophagous"))
# colnames(data.wr)
# weights <- data.wr[,-c(1:4)]
# weights <- as.vector(data.wr)
```




##  Calculating SAC

```{r, results='hide'}
alphaaccumlist <- list()

tsa <- levels(data.alpha.controls$TSA)
# pdf(here("results", "accumCurvesControls.pdf"), width = 10, height = 8)
par(mfrow = c(2, 2))
for(i in seq_along(tsa)) {
  
  # definir a matriz a analisar
  data.alpha.controls.matrix <- data.alpha.controls[which(data.alpha.controls$TSA == tsa[i]), -1]
  alphaaccumlist[[i]] <- alpha.accum(data.alpha.controls.matrix, prog = F)
  
  # plot(alphaaccumlist[[i]][,1], alphaaccumlist[[i]][,2], xlab="Samples", ylab="Individuals", )
  plot(alphaaccumlist[[i]][, 1], alphaaccumlist[[i]][, 3], xlab = "Samples", ylab = "Individuals",
       ylim = c(0,40), xlim = c(0,25), main = tsa[i], las =1, type="n")
  lines(alphaaccumlist[[i]][, 1], alphaaccumlist[[i]][, 4], col="gray30", lwd=2)
  lines(alphaaccumlist[[i]][, 1], alphaaccumlist[[i]][, 5], col = "pink", lwd=2)
  lines(alphaaccumlist[[i]][, 1], alphaaccumlist[[i]][, 9], col = "red", lwd=2)
  lines(alphaaccumlist[[i]][, 1], alphaaccumlist[[i]][, 17], col = "purple", lwd=2)
  points(alphaaccumlist[[i]][, 1], alphaaccumlist[[i]][, 3], pch=21, bg = "#1B80C8", cex=1.2)
  points(alphaaccumlist[[i]][, 1], alphaaccumlist[[i]][, 13], pch=21, bg = "brown", cex=1.2)
  points(alphaaccumlist[[i]][, 1], alphaaccumlist[[i]][, 19], pch=21, bg = "#0ABF02", cex=1.2)
}
# dev.off()

```

Lines
Gray   - Singletons
Pink   - Doubletons
Red     - Jack1 Ab
Purple  - Jack2 ab P

Points

Blue    - Chao 1P
Green   - Chao 2P

## Calculating functional elements

```{r}
dissimAll <- cluster::daisy(Traits, "gower", weights = weights)  # Calculating distances between species
#      https://www.rdocumentation.org/packages/cluster/versions/2.0.7-1/topics/daisy


tree <- hclust(dissimAll, "average")     
par(mfrow=c(1,1))
plot(tree, hang = -1)  ## PQ O HANG= - 1?

# All natives tree and FD Alpha----
dissimNat <- cluster::daisy(TraitsNat, "gower", weights = weights)  # Calculating distances between species
treeNat <- hclust(dissimNat, "average")  # building the dendrogram
cor(dissimNat, cophenetic(treeNat))

par(mfrow=c(1,1))
plot(treeNat, hang = -1)  ## PQ O HANG= - 1?
#  plot(as.dendrogram(treeNat))
str(TraitsNInd)

# All Non-Ind tree and FD Alpha ----
dissimNInd <- cluster::daisy(TraitsNInd, "gower", weights = weights)  # Calculating distances between species
treeNInd <- hclust(dissimNInd, "average")          # building the 
par(mfrow=c(1,1))
plot(treeNInd, hang = -1)  ## PQ O HANG= - 1?
```

## Calculating taxonomical and Functional Alphas 

```{r}
#Taxonomical Alpha
Alpha_All <- alpha(SAAll)
Alpha_Nat<- alpha(SANat)
Alpha_NInd<- alpha(SANInd)

#Functional Alpha
FDalphaAll <- alpha(SAAll, tree)
FDalphaNat <- alpha(SANat, treeNat)
FDalphaNInd <- alpha(SANInd, treeNInd)

Alphas <- as.data.frame(cbind(Alpha_All, Alpha_Nat, Alpha_NInd, FDalphaAll, FDalphaNat, FDalphaNInd))
colnames(Alphas) <- cbind("TAlphaAll", "TAlphaNat", "TAlphaNInd","FAlphaAll", "FAlphaNat", "FAlphaNInd" )
Alphas # Will be printed along with BETAS in the RESULTS file

```



```{r}
## Calculating taxonomical and Functional Alphas 
# Taxonomical Beta
BetaAll <- beta(SAAll)
BetaNat <- beta(SANat)
BetaNat <- beta(SANInd) 

#Functional Beta
BetaFuncAll <- beta(SAAll, tree,  abund =  T)
BetaFuncNat <- beta(SANat, treeNat, abund = T) 
BetaFuncNInd <- beta(SANInd, treeNInd, abund= T)


```

## Separating Beta components

```{r}
## Separating Total, Richness and Replacement  TAXONOMICAL betas into different data frames
BetaAllTotal <- data.frame(as.matrix(BetaAll[["Btotal"]]), sep= "tab")
BetaAllRich <- data.frame(as.matrix(BetaAll[["Brich"]]), sep= "tab")
BetaAllRepl <- data.frame(as.matrix(BetaAll[["Brepl"]]), sep= "tab")
BetaNatTotal <- data.frame(as.matrix(BetaNat[["Btotal"]]), sep= "tab")
BetaNatRich <- data.frame(as.matrix(BetaNat[["Brich"]]), sep= "tab")
BetaNatRepl <- data.frame(as.matrix(BetaNat[["Brepl"]]), sep= "tab")
BetaNIndTotal <- data.frame(as.matrix(BetaNat[["Btotal"]]), sep= "tab")
BetaNIndRich <- data.frame(as.matrix(BetaNat[["Brich"]]), sep= "tab")
BetaNIndRepl <- data.frame(as.matrix(BetaNat[["Brepl"]]), sep= "tab")

## Separating Total, Richness and Replacement  FUNCTIONAL betas into different data frames
BetaFuncAllTotal <- data.frame(as.matrix(BetaFuncAll[["Btotal"]]), sep= "tab")
BetaFuncAllRich <- data.frame(as.matrix(BetaFuncAll[["Brich"]]), sep= "tab")
BetaFuncAllRepl <- data.frame(as.matrix(BetaFuncAll[["Brepl"]]), sep= "tab")
BetaFuncNatTotal <- data.frame(as.matrix(BetaFuncNat[["Btotal"]]), sep= "tab")
BetaFuncNatRich <- data.frame(as.matrix(BetaFuncNat[["Brich"]]), sep= "tab")
BetaFuncNatRepl <- data.frame(as.matrix(BetaFuncNat[["Brepl"]]), sep= "tab")
BetaFuncNIndTotal <- data.frame(as.matrix(BetaFuncNat[["Btotal"]]), sep= "tab")
BetaFuncNIndRich <- data.frame(as.matrix(BetaFuncNat[["Brich"]]), sep= "tab")
BetaFuncNIndRepl <- as.data.frame(as.matrix(BetaFuncNat[["Brepl"]]), sep= "tab")
```

## Separating comparisons with Controls

```{r}
A01 <- BetaAllTotal[1,1]
AA1 <- BetaAllTotal[6,c(2:6)]
BB1 <- BetaAllTotal[12,c(7:12)]
CC1 <- BetaAllTotal[18,c(13:18)]
DD1 <- BetaAllTotal[22,c(19:22)]
BetaAllTotalVector <- c(A01,AA1, BB1,  CC1, DD1)

A02 <- BetaAllRich[1,1]
AA2 <- BetaAllRich[6,c(2:6)]
BB2 <- BetaAllRich[12,c(7:12)]
CC2 <- BetaAllRich[18,c(13:18)]
DD2<- BetaAllRich[22,c(19:22)]
BetaAllRichVector <- c(A02,AA2, BB2,  CC2, DD2)

A03 <- BetaAllRepl[1,1]
AA3 <- BetaAllRepl[6,c(2:6)]
BB3 <- BetaAllRepl[12,c(7:12)]
CC3 <- BetaAllRepl[18,c(13:18)]
DD3 <- BetaAllRepl[22,c(19:22)]
BetaAllReplVector <- c(A03,AA3, BB3, CC3, DD3)

A01 <- BetaNatTotal[1,1]
AA1 <- BetaNatTotal[6,c(2:6)]
BB1 <- BetaNatTotal[12,c(7:12)]
CC1 <- BetaNatTotal[18,c(13:18)]
DD1 <- BetaNatTotal[22,c(19:22)]
BetaNatTotalVector <- c(A01,AA1, BB1,  CC1, DD1)

A02 <- BetaNatRich[1,1]
AA2 <- BetaNatRich[6,c(2:6)]
BB2 <- BetaNatRich[12,c(7:12)]
CC2 <- BetaNatRich[18,c(13:18)]
DD2<- BetaNatRich[22,c(19:22)]
BetaNatRichVector <- c(A02,AA2, BB2,  CC2, DD2)

A03 <- BetaNatRepl[1,1]
AA3 <- BetaNatRepl[6,c(2:6)]
BB3 <- BetaNatRepl[12,c(7:12)]
CC3 <- BetaNatRepl[18,c(13:18)]
DD3 <- BetaNatRepl[22,c(19:22)]
BetaNatReplVector <- c(A03,AA3, BB3, CC3, DD3)

A01 <- BetaNIndTotal[1,1]
AA1 <- BetaNIndTotal[6,c(2:6)]
BB1 <- BetaNIndTotal[12,c(7:12)]
CC1 <- BetaNIndTotal[18,c(13:18)]
DD1 <- BetaNIndTotal[22,c(19:22)]
BetaNIndTotalVector <- c(A01,AA1, BB1,  CC1, DD1)

A02 <- BetaNIndRich[1,1]
AA2 <- BetaNIndRich[6,c(2:6)]
BB2 <- BetaNIndRich[12,c(7:12)]
CC2 <- BetaNIndRich[18,c(13:18)]
DD2<- BetaNIndRich[22,c(19:22)]
BetaNIndRichVector <- c(A02,AA2, BB2,  CC2, DD2)

A03 <- BetaNIndRepl[1,1]
AA3 <- BetaNIndRepl[6,c(2:6)]
BB3 <- BetaNIndRepl[12,c(7:12)]
CC3 <- BetaNIndRepl[18,c(13:18)]
DD3 <- BetaNIndRepl[22,c(19:22)]
BetaNIndReplVector <- c(A03,AA3, BB3, CC3, DD3)

## Separating the FUNCTIONAL beta values between the Control 250/Max and the other sampling areas from each trail


A01 <- BetaFuncAllTotal[1,1]
AA1 <- BetaFuncAllTotal[6,c(2:6)]
BB1 <- BetaFuncAllTotal[12,c(7:12)]
CC1 <- BetaFuncAllTotal[18,c(13:18)]
DD1 <- BetaFuncAllTotal[22,c(19:22)]
BetaFuncAllTotalVector <- c(A01,AA1, BB1,  CC1, DD1)

A02 <- BetaFuncAllRich[1,1]
AA2 <- BetaFuncAllRich[6,c(2:6)]
BB2 <- BetaFuncAllRich[12,c(7:12)]
CC2 <- BetaFuncAllRich[18,c(13:18)]
DD2<- BetaFuncAllRich[22,c(19:22)]
BetaFuncAllRichVector <- c(A02,AA2, BB2,  CC2, DD2)

A03 <- BetaFuncAllRepl[1,1]
AA3 <- BetaFuncAllRepl[6,c(2:6)]
BB3 <- BetaFuncAllRepl[12,c(7:12)]
CC3 <- BetaFuncAllRepl[18,c(13:18)]
DD3 <- BetaFuncAllRepl[22,c(19:22)]
BetaFuncAllReplVector <- c(A03,AA3, BB3, CC3, DD3)

A01 <- BetaFuncNatTotal[1,1]
AA1 <- BetaFuncNatTotal[6,c(2:6)]
BB1 <- BetaFuncNatTotal[12,c(7:12)]
CC1 <- BetaFuncNatTotal[18,c(13:18)]
DD1 <- BetaFuncNatTotal[22,c(19:22)]
BetaFuncNatTotalVector <- c(A01,AA1, BB1,  CC1, DD1)

A02 <- BetaFuncNatRich[1,1]
AA2 <- BetaFuncNatRich[6,c(2:6)]
BB2 <- BetaFuncNatRich[12,c(7:12)]
CC2 <- BetaFuncNatRich[18,c(13:18)]
DD2<- BetaFuncNatRich[22,c(19:22)]
BetaFuncNatRichVector <- c(A02,AA2, BB2,  CC2, DD2)

A03 <- BetaFuncNatRepl[1,1]
AA3 <- BetaFuncNatRepl[6,c(2:6)]
BB3 <- BetaFuncNatRepl[12,c(7:12)]
CC3 <- BetaFuncNatRepl[18,c(13:18)]
DD3 <- BetaFuncNatRepl[22,c(19:22)]
BetaFuncNatReplVector <- c(A03,AA3, BB3, CC3, DD3)

A01 <- BetaFuncNIndTotal[1,1]
AA1 <- BetaFuncNIndTotal[6,c(2:6)]
BB1 <- BetaFuncNIndTotal[12,c(7:12)]
CC1 <- BetaFuncNIndTotal[18,c(13:18)]
DD1 <- BetaFuncNIndTotal[22,c(19:22)]
BetaFuncNIndTotalVector <- c(A01,AA1, BB1,  CC1, DD1)

A02 <- BetaFuncNIndRich[1,1]
AA2 <- BetaFuncNIndRich[6,c(2:6)]
BB2 <- BetaFuncNIndRich[12,c(7:12)]
CC2 <- BetaFuncNIndRich[18,c(13:18)]
DD2<- BetaFuncNIndRich[22,c(19:22)]
BetaFuncNIndRichVector <- c(A02,AA2, BB2,  CC2, DD2)

A03 <- BetaFuncNIndRepl[1,1]
AA3 <- BetaFuncNIndRepl[6,c(2:6)]
BB3 <- BetaFuncNIndRepl[12,c(7:12)]
CC3 <- BetaFuncNIndRepl[18,c(13:18)]
DD3 <- BetaFuncNIndRepl[22,c(19:22)]
BetaFuncNIndReplVector <- c(A03,AA3, BB3, CC3, DD3)
```

## Calculating betas

```{r}
Betas <- as.data.frame( t(rbind(
  BetaAllTotalVector, BetaAllRichVector, BetaAllReplVector, 
  BetaFuncAllTotalVector, BetaFuncAllRichVector, BetaFuncAllReplVector,
  BetaNatTotalVector, BetaNatRichVector, BetaNatReplVector, 
  BetaFuncNatTotalVector, BetaFuncNatRichVector, BetaFuncNatReplVector,
  BetaNIndTotalVector, BetaNIndRichVector, BetaNIndReplVector,
  BetaFuncNIndTotalVector, BetaFuncNIndRichVector, BetaFuncNIndReplVector)))

str(Betas)
```

## Exporting results

```{r}
write.csv(BetaAllTotal,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaAllTotal.csv")
write.csv(BetaAllRich,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaAllRich.csv")
write.csv(BetaAllRepl,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaAllRepl.csv")
write.csv(BetaNatTotal,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaNatTotal.csv")
write.csv(BetaNatRich,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaNatRich.csv")
write.csv(BetaNatRepl,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaNatRepl.csv")
write.csv(BetaNIndTotal,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaNIndTotal.csv")
write.csv(BetaNIndRich,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaNIndRich.csv")
write.csv(BetaNIndRepl,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaResults/BetaNIndRepl.csv")

## Exporting FUNCTIONAL beta results to .csv (for the record - it won't be usedin analysis, as the RESULTS 
#       file compiles all the  useable results )

write.csv(BetaFuncAllTotal,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncAllTotal.csv")
write.csv(BetaFuncAllRich,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncAllRich.csv")
write.csv(BetaFuncAllRepl,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncAllRepl.csv")
write.csv(BetaFuncNatTotal,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncNatTotal.csv")
write.csv(BetaFuncNatRich,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncNatRich.csv")
write.csv(BetaFuncNatRepl,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncNatRepl.csv")
write.csv(BetaFuncNIndTotal,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncNIndTotal.csv")
write.csv(BetaFuncNIndRich,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncNIndRich.csv")
write.csv(BetaFuncNIndRepl,file = "C:/ArthropodsArticle/2.0 _Finland_Analysis/BetaFuncResults/BetaFuncNIndRepl.csv")

```

### Results export

```{r}
Results <- cbind.data.frame(data.variables, Alphas, Betas)
str(Results)

#MAKING THE RESULTS EXPORTABLE INTO CSV
Results <- apply(Results, 2 , as.character)

#NAMING THE TRAIL SEGMENTS
rownames(Results) <- rownames(Alphas)

#PASSING RESULTS TO FILE
write.csv(Results, file = here("results","RESULTS.csv"), row.names = TRUE)

Results2 <- read.csv2(here("results","RESULTS.CSV"), header=TRUE, row.names = 1,  stringsAsFactors = T,sep = ",", dec = ".")
str(Results2)

Results3 <- read.csv("RESULTS.csv", header = TRUE, row.names = 1, sep = ",", dec = ".")
str(Results3)
ResultsWithoutControls <- Results3[-c(5,6,11,12,17,18),-c(1:2)]
```

## MDS

```{r}

MDSfile <- fread(here("data","MDS_vectors.csv"))
str(MDSfile)
trail <- MDSfile[,1]
trail
trail <- as.vector(trail)
treatment <- MDSfile[,2]
str(treatment)
treatment <- as.vector(treatment)
str(treatment)


#¬£metaMDS(Results3, distance = "bray", k = 2, try = 20, trymax = 20)

#ordiellipse(mds, groups  = as.factor(treatment), label = T)
mds1 <- metaMDS(BetaAll$Btotal, k=2, trymax = 100)
plot(mds1)
ordiellipse(mds1, groups  = as.factor(trail), label = T)
ordiellipse(mds1, groups  = as.factor(treatment), label = T)

mds2 <- metaMDS(BetaAll$Brepl, k=3, trymax = 100)
plot(mds2)
ordiellipse(mds2, groups  = as.factor(trail), label = T)
ordiellipse(mds2, groups  = as.factor(treatment), label = T)

mds3 <- metaMDS(BetaNat$Btotal, k=3, trymax = 100)
plot(mds3)
ordiellipse(mds3, groups  = as.factor(trail), label = T)
ordiellipse(mds3, groups  = as.factor(treatment), label = T)

mds4 <- metaMDS(BetaNat$Brepl, k=3, trymax = 100)
plot(mds4)
ordiellipse(mds4, groups  = as.factor(trail), label = T)
ordiellipse(mds4, groups  = as.factor(treatment), label = T)

mds5 <- metaMDS(BetaFuncAll$Btotal, k=3, trymax = 100)
plot(mds5)
ordiellipse(mds5, groups  = as.factor(trail), label = T)
ordiellipse(mds5, groups  = as.factor(treatment), label = T)

mds6 <- metaMDS(BetaFuncAll$Brepl, k=3, trymax = 100)
plot(mds6)
ordiellipse(mds6, groups  = as.factor(trail), label = T)
ordiellipse(mds6, groups  = as.factor(treatment), label = T)

mds7 <- metaMDS(BetaFuncNat$Btotal, k=3, trymax = 100)
plot(mds7)
ordiellipse(mds7, groups  = as.factor(trail), label = T)
ordiellipse(mds7, groups  = as.factor(treatment), label = T)

mds8 <- metaMDS(BetaFuncNat$Brepl, k=3, trymax = 100)
plot(mds8)
ordiellipse(mds8, groups  = as.factor(trail), label = T)
ordiellipse(mds8, groups  = as.factor(treatment), label = T)
```

## GLMM - Alphas



### Is taxonomical alpha explained by EdgeDist and DistTrailBeginning?



```{r}
glmm_TAlphaAll_AB<-glmer(TAlphaAll ~ Dist_edge + Dist_trail_beginning + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaAll_AB)
```





```{r}
#TAlphaAll

glmmT_AlphaAll_A<-glmer(TAlphaAll ~ Dist_edge + (1 | ForestID), data = Results2, family = poisson)
summary(glmmT_AlphaAll_A)

glmm_TAlphaAll_B<-glmer(TAlphaAll ~  Dist_trail_beginning + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaAll_B)

glmm_TAlphaAll_C<-glmer(TAlphaAll ~  treatment + Dist_edge + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaAll_C)

#FAlphaAll

glmm_FAlphaAll_AB <- glmer(FAlphaAll ~ Dist_edge + Dist_trail_beginning + (1 | ForestID), data = Results2 , family = gaussian)
summary(glmm_FAlphaAll_AB)

glmmT_AlphaAll_A<-glmer(FAlphaAll ~ Dist_edge + (1 | ForestID), data = Results2, family = gaussian)
summary(glmmT_AlphaAll_A)

glmm_FAlphaAll_B<-glmer(FAlphaAll ~  Dist_trail_beginning + (1 | ForestID), data = Results2 , family = gaussian)
summary(glmm_FAlphaAll_B)

glmm_FAlphaAll_C<-glmer(FAlphaAll ~  treatment+ (1 | ForestID), data = Results2 , family = gaussian)
summary(glmm_FAlphaAll_C)


##### Natives ####

#TAlphaAll

glmm_TAlphaNat_AB<-glmer(TAlphaNat ~ Dist_edge + Dist_trail_beginning + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaNat_AB)

glmmT_AlphaNat_A<-glmer(TAlphaNat ~ Dist_edge + (1 | ForestID), data = Results2, family = poisson)
summary(glmmT_AlphaNat_A)

glmm_TAlphaNat_B<-glmer(TAlphaNat ~  Dist_trail_beginning + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaNat_B)

glmm_TAlphaNat_c<-glmer(TAlphaNat ~  Dist_edge + treatment + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaNat_c)

#FAlphaNat

glmm_FAlphaNat_AB <- glmer(FAlphaNat ~ Dist_edge + Dist_trail_beginning + (1 | ForestID), data = Results2 , family = gaussian)
summary(glmm_FAlphaNat_AB)

glmmT_AlphaNat_A<-glmer(FAlphaNat ~ Dist_edge + (1 | ForestID), data = Results2, family = gaussian)
summary(glmmT_AlphaNat_A)

glmm_FAlphaNat_B<-glmer(FAlphaNat ~  Dist_trail_beginning + (1 | ForestID), data = Results2 , family = gaussian)
summary(glmm_FAlphaNat_B)

glmm_FAlphaNat_C<-glmer(FAlphaNat ~  treatment + (1 | ForestID), data = Results2 , family = gaussian)
summary(glmm_FAlphaNat_C)

##### Non-Natives ################

#TAlphaAll

glmm_TAlphaNInd_AB<-glmer(TAlphaNInd ~ Dist_edge + Dist_trail_beginning + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaNInd_AB)

glmmT_AlphaNInd_A<-glmer(TAlphaNInd ~ Dist_edge + (1 | ForestID), data = Results2, family = poisson)
summary(glmmT_AlphaNInd_A)



glmm_TAlphaNInd_B<-glmer(TAlphaNInd ~  Dist_trail_beginning + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaNInd_B)


# O TC250 d√° intera√ß√£o significativa
glmm_TAlphaNInd_C<-glmer(TAlphaNInd ~  treatment + (1 | ForestID), data = Results2 , family = poisson)
summary(glmm_TAlphaNInd_C)


#FAlphaNInd

glmm_FAlphaNInd_AB <- glmer(FAlphaNInd ~ Dist_edge + Dist_trail_beginning + (1 | ForestID), data = Results2 , family = gaussian)
summary(glmm_FAlphaNInd_AB)

glmmT_AlphaNInd_A<-glmer(FAlphaNInd ~ Dist_edge + (1 | ForestID), data = Results2, family = gaussian)
summary(glmmT_AlphaNInd_)A

glmm_FAlphaNInd_B<-glmer(FAlphaNInd ~  Dist_trail_beginning + (1 | ForestID), data = Results2 , family = gaussian)
summary(glmm_FAlphaNInd_B)
```

# GLMM Betas

```{r}
glmm_BetaAllTotalVector_AB<-glmer(BetaAllTotalVector ~  treatment + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_BetaAllTotalVector_AB)

glmmT_BetaAllTotalVector_A<-glmer(BetaAllTotalVector ~ Dist_edge + (1 | ForestID), data = Results2, family = binomial)
summary(glmmT_BetaAllTotalVector_A)

glmm_BetaAllTotalVector_B<-glmer(BetaAllTotalVector ~  Dist_trail_beginning + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_BetaAllTotalVector_B)

glmm_BetaAllTotalVector_C<-glmer(BetaAllTotalVector ~  treatment + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_BetaAllTotalVector_C)

#FBetaAll

glmm_FBetaAll_AB <- glmer(BetaFuncAllTotalVector~ Dist_edge + treatment + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_FBetaAll_AB)

glmm_FBetaAll_A<-glmer(BetaFuncAllTotalVector ~ treatment + (1 | ForestID), data = Results2, family = binomial)
summary(glmm_FBetaAll_A)

glmm_FBetaAll_B <- glmer(BetaFuncAllTotalVector ~ Dist_edge + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_FBetaAll_B)

##### natives################


#TBetaAll

glmm_BetaNatTotalVector_AB<-glmer(BetaNatTotalVector ~  treatment + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_BetaNatTotalVector_AB)

glmmT_BetaNatTotalVector_A<-glmer(BetaNatTotalVector ~ Dist_edge + (1 | ForestID), data = Results2, family = binomial)
summary(glmmT_BetaNatTotalVector_A)

glmm_BetaNatTotalVector_B<-glmer(BetaNatTotalVector ~  Dist_trail_beginning + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_BetaNatTotalVector_B)

glmm_BetaNatTotalVector_C<-glmer(BetaNatTotalVector ~  treatment + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_BetaNatTotalVector_C)

#FAlphaNat

glmm_FBetaNat_AB <- glmer(BetaFuncNatTotalVector ~ Dist_edge + treatment + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_FBetaNat_AB)

glmmT_BetaNat_A<-glmer(BetaFuncNatTotalVector ~ treatment + (1 | ForestID), data = Results2, family = binomial)
summary(glmmT_AlphaNat_A)

glmm_FBetaNat_B <- glmer(BetaFuncNatTotalVector ~ Dist_edge + (1 | ForestID), data = Results2 , family = binomial)
summary(glmm_FBetaNat_B)
```

